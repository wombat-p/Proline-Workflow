library(matrixStats)
library(stringi)

#Reading files
peptides <- read.csv("polystest_pep_res.csv")
proteins <- read.csv("polystest_prot_res.csv")
exp_design <- read.csv("exp_design.txt", sep="\t")
colnames(exp_design)[1:2] <- c("raw_file", "exp_condition")
write.table(exp_design, "exp_design.txt", sep="\t", row.names=F)

# Converting column names
colnames(peptides) <- sub("^psm_count_", "number_of_psms_", colnames(peptides))
colnames(peptides) <- sub("^log\\.ratios\\.", "log_ratios_", colnames(peptides))
for (s in unique(exp_design$exp_condition)) colnames(peptides) <- sub(paste0("^X",s,"\\."), paste0("abundance_",s,"_"), colnames(peptides))
colnames(peptides) <- sub("^FDR\\.PolySTest\\.X", "differential_regulation_", colnames(peptides))

#Creating modified sequences
modified_peptides <- strsplit(peptides$modifications, "; ")
modified_peptides <- lapply(modified_peptides, function(x) {
  if(any(!is.na(x))) {
    tt <- matrix(unlist(strsplit(x, " \\(")), nrow=2)
    tt[2,] <- sub("\\)","",tt[2,])
    modpos <- NULL
    for (i in 1:ncol(tt)) {
      modpos <- append(modpos, ifelse(grepl("N-term|C-term", tt[2,i]), 0, sub("[A-Z]","",tt[2,i])))
    }
    tt <- rbind(tt, modpos)
  } else {
    NA
  }
})

modified_sequence <- peptides$sequence
for (i in 1:nrow(peptides)) {
  if (!is.na(modified_peptides[[i]][1])) {
    modified_sequence[i] <- stri_sub_replace_all(modified_sequence[i], replacement = paste0("[",modified_peptides[[i]][1,],"]"), 
                                                 from=as.numeric(modified_peptides[[i]][3,])+1, 
                         to=as.numeric(modified_peptides[[i]][3,]))
  }
}
peptides$modified_sequence <- modified_sequence
stand_peps <- data.frame("modified_peptide"=peptides$modified_sequence, protein_group=peptides$samesets_accessions, 
                         peptides[, grep("^number_of_psms", colnames(peptides))],
                         2^peptides[, grep("^abundance", colnames(peptides))],
                         peptides[, grep("^log_ratios", colnames(peptides))],
                         peptides[, grep("^differential_regulation", colnames(peptides))])

# deleting charge states with lower intensities to maintain max. 1 (modified) peptide sequence
stand_peps <- stand_peps[order(rowMeans(peptides[, grep("^abundance", colnames(peptides))], na.rm = T), decreasing=T),]
stand_peps <- stand_peps[!duplicated(stand_peps$modified_peptide), ]
stand_peps <- stand_peps[order(stand_peps$protein_group), ]
write.csv(stand_peps, "stand_pep_quant_merged.csv")

colnames(proteins)
# Converting column names
colnames(proteins) <- sub("^peptides_count_", "number_of_peptides_", colnames(proteins))
colnames(proteins) <- sub("^log\\.ratios\\.", "log_ratios_", colnames(proteins))
for (s in unique(exp_design$exp_condition)) colnames(proteins) <- sub(paste0("^X",s,"\\."), paste0("abundance_",s,"_"), colnames(proteins))
colnames(proteins) <- sub("^FDR\\.PolySTest\\.X", "differential_regulation_", colnames(proteins))
stand_prots <- data.frame(protein_group=proteins$samesets_accessions, 
                          proteins[, grep("^number_of_peptides", colnames(proteins))],
                          proteins[, grep("^abundance_", colnames(proteins))],
                          proteins[, grep("^log_ratios", colnames(proteins))],
                          proteins[, grep("^differential_regulation_", colnames(proteins))]
                          )
write.csv(stand_prots, "stand_prot_quant_merged.csv")

